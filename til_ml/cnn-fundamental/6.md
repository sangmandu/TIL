# 데이터 증강의 이해 - Keras ImageDataGenerator 활용

## 데이터 증강\(Data Augmentation\)의 이해

#### 데이터 증강 개요

CNN 모델의 성능을 높이고 오버피팅을 극복할 수 있는 가장 좋은 방법

* **다양한** 유형의 학습 이미지 데이터의 **양** 을 늘리는 것임
* 이미지 데이터는 데이터 양을 늘리기 쉽지 않음

Data Augmentation은 학습 시에 원본 이미지에 다양한 변형을 가해서 학습 이미지 데이터를 늘리는 것과 유사한 효과를 발휘하고자 하는 것

원본 학습 이미지의 개수를 늘리는 것이 아니라, 학습 시 마다 개별 원본 이미지를 변형해서 학습을 수행하는 것

* 6만개의 이미지를 10번의 변형을 통해 60만개의 이미지를 생성하는 것이 아니다
* 6만개의 이미지를 10번의 변형을 거쳐 각 Iteration 마다 다르게 입력하는 것

#### Augmentation 유형

공간 레벨 변형

* Flip : 대칭 변환\(상하좌우\)
* Crop : 특정 영역 확대
* Affine : 회전, 수평이동, 크기변환, 압축

픽셀 레벨 변형

* 밝기 변환, 채도 변환, 명도 변환, 그레이 스케일, 혼합 등



대표적으로 `Keras ImageDataGenerator` 가 Augmentation을 지원한다.

* 장점
  * 매우 쉽게 Aug. 가능
* 단점 
  * 제한적인 변환 기능
  * 속도가 느림
  * 임의로 적용되기 때문에 각 기능별로 변환 확률을 정할 수 없음
* 그 외에도 다음과 같은 것들이 있다.
*  `Albumentations` , `ImgAug`
  * 다양한 Aug. 기법 제공 및 적용 확률 제공
  * Object Detection이나 Segmentation도 같이 변환
  * 케라스 파이프라인 통합을 위한 별도의 작업이 필요하다
* `Tensorflow Image Libarary`
  * 다양한 Image API 기능 제공. OpenCV나 scikit-image같은 기능을 많이 제공하려고 함
  * 빠른 Aug. 속도
  * tf.dataset과 쉽게 통합되고 Keras Layer와 결합되면 GPU 사용 가능
  * 다양한 Aug 기능이 없고, 입력 데이터 타입이 Numpy가 아니라 Tensor 여야 되서 불편함이 있음



## Keras의 ImageDataGenerator 특징

#### ImageDataGenerator 특징

* Keras 내에서 쉽게 Aug. 가능
* 그렇지만 Aug. 기능이 제한적이다. 그러나 기본적인 기능만으로도 효율적이게 적용 가능
* 개별적으로 이미지 변환을 적용하기가 어렵고 시간도 상대적으로 오래 걸린다.
* Preprocessing과 fit\(\)이 밀접하게 연결하여 적용된다.

#### 메커니즘

1. 이미지 파일
2. ImageDataGenerator
   * 다양한 Aug. 설정
   * rescale 설정
   * 기타 Preprocessing 설정
3. Iterator
   * Batch 크기 만큼 데이터 할당
4. Model
   * Iterator 옵션 설정

Aug 유형 중 ZCAWhitening은 버그로 인해 사용에 유의해야 한다

* 보통 사용 지양





## ImageDataGenerator로 Augmentation 적용 - 01

```python
from tensorflow.keras.preprocessing.image import ImageDataGenerator

data_generator = ImageDataGenerator(horizontal_flip=True)

image_batch = np.expand_dims(image, axis=0)
print('image_batch shape:', image_batch.shape)

data_generator.fit(image_batch)
data_gen_iter = data_generator.flow(image_batch)

aug_image_batch = next(data_gen_iter)

aug_image = np.squeeze(aug_image_batch)
print('aug_image shape:', aug_image.shape)

aug_image = aug_image.astype('int')
show_image(aug_image)
```

* 3 : Horizontal Flip\(좌우 반전\)을 적용. horizontal\_flip=True을 적용했지만 반드시 변환하는 것은 아님. Random하게 원본 데이터를 유지하거나 변환 결정. 따라서 실제 실행해보면 반전이 된 이미지가 출력될수도, 원본 이미지가 출력될 수도 있다.
* 5 : ImageDataGenerator는 여러개의 image를 입력으로 받음. 따라서 3차원이 아니라 batch를 포함한 4차원 array를 입력받음. np.expand\_dims\(\)로 차원 증가.
* 8 : ImageDataGenerator 적용. fit\(\)후 flow\(\)로 image batch를 넣어주어야 함. fit\(\)은 이후에 batch normalization을 하기위해 필요한 과정이고 필수적인 파이프라인 요소는 아니다. 또, flow\(\)는 파이프라인을 구성하는 단계이지 실제로 실행하는 것이 아니다. 실행은 다음 코드
* 11 : ImageDataGenerator를 동작하기 위해서는 next\(\)등으로 iteration을 호출해야한다
* 13 : 반환된 데이터는 batch까지 포함된 4차원 array이므로 다시 3차원 image array로 변환.
* 16 : 반환된 pixel값은 float임. 이를 다시 int형으로 변경 후, 이미지 시각화

## ImageDataGenerator로 Augmentation 적용 - 02

## CIFAR10 데이터 셋에 Augmentation 적용 후 모델 성능 비교 - 01

## CIFAR10 데이터 셋에 Augmentation 적용 후 모델 성능 비교 - 02

